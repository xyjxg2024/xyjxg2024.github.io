<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â€œå†œåœºç®¡å®¶â€å†œä¸šå¤§æ•°æ®åˆ†æå¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
    <style>
        /* ================= å…¨å±€æ ·å¼ ================= */
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(to bottom, #f0fff1, #e1f4e8);
            margin: 0;
            min-height: 100vh;
            position: relative;
        }

        /* ================= ç™»å½•æ³¨å†Œæ ·å¼ ================= */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
            width: 400px;
            transform: translateY(-20px);
            transition: all 0.3s;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-title {
            color: #3d8c53;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .auth-switch {
            color: #8bc34a;
            cursor: pointer;
            font-size: 14px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-input {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .auth-input:focus {
            border-color: #8bc34a;
            outline: none;
        }

        .auth-button {
            background: #8bc34a;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .auth-button:hover {
            background: #7cb342;
        }

        /* ================= ä¸»ç•Œé¢æ ·å¼ ================= */
        .main-content {
            display: none;
        }

        h1 {
            color: #3d8c53;
            text-align: center;
            padding: 25px 0;
            margin: 0;
            font-size: 2.4em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* ================= æŒ‰é’®å®¹å™¨æ ·å¼ ================= */
        .button-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 20px 20px;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #3d8c53;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .logout-button {
            padding: 10px 16px;
            background: #8bc34a;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .logout-button:hover {
            background: #7cb342;
        }

        .chat-container {
            max-width: 800px;
            margin: 25px auto;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 15px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
            height: 75vh;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin: 15px 10px;
            padding: 18px 25px;
            border-radius: 20px;
            max-width: 85%;
            line-height: 1.7;
            word-break: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: #8bc34a;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background: #f8f8f8;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        .input-container {
            display: flex;
            gap: 15px;
            max-width: 800px;
            margin: 25px auto;
            padding: 0 25px;
        }

        #questionInput {
            flex: 1;
            padding: 16px 25px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }

        #questionInput:focus {
            border-color: #8bc34a;
            box-shadow: 0 0 8px rgba(139, 195, 74, 0.2);
            outline: none;
        }

        #sendButton {
            background: #8bc34a;
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        #sendButton:hover {
            background: #7cb342;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        #sendButton:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-message {
            color: #8bc34a;
            text-align: center;
            padding: 15px;
            font-style: italic;
        }

        .error-message {
            color: #dc3545;
            background: #ffecec;
            border: 1px solid #ffc4c4;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <!-- ç™»å½•æ³¨å†Œæ¨¡å— -->
    <div class="auth-modal" id="authModal">
        <!-- ç™»å½•è¡¨å• -->
        <div class="auth-box" id="loginBox">
            <div class="auth-header">
                <div class="auth-title">æ¬¢è¿å›æ¥ ğŸŒ±</div>
                <div>è¯·ç™»å½•æ‚¨çš„å†œåœºç®¡å®¶è´¦æˆ·</div>
            </div>
            <form class="auth-form" id="loginForm">
                <input type="text" class="auth-input" placeholder="ç”¨æˆ·å">
                <input type="password" class="auth-input" placeholder="å¯†ç ">
                <button type="button" class="auth-button" onclick="hideAuthModal()">ç™»å½•</button>
                <div class="auth-switch" onclick="showRegister()">è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿç«‹å³æ³¨å†Œ</div>
            </form>
        </div>

        <!-- æ³¨å†Œè¡¨å• -->
        <div class="auth-box" id="registerBox" style="display: none;">
            <div class="auth-header">
                <div class="auth-title">åˆ›å»ºæ–°è´¦æˆ· ğŸŒ¾</div>
                <div>ç«‹å³åŠ å…¥æ™ºèƒ½å†œä¸šç®¡ç†</div>
            </div>
            <form class="auth-form" id="registerForm">
                <input type="text" class="auth-input" placeholder="ç”¨æˆ·å">
                <input type="password" class="auth-input" placeholder="å¯†ç ">
                <input type="password" class="auth-input" placeholder="ç¡®è®¤å¯†ç ">
                <button type="button" class="auth-button" onclick="hideAuthModal()">æ³¨å†Œ</button>
                <div class="auth-switch" onclick="showLogin()">å·²æœ‰è´¦æˆ·ï¼Ÿç«‹å³ç™»å½•</div>
            </form>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
        <!-- å·¦ä¸Šè§’å›ºå®šè¿”å›ä¸»é¡µæŒ‰é’® -->
        <a href="index.html" class="back-button">â† è¿”å›ä¸»é¡µ</a>

        <h1>â€œå†œåœºç®¡å®¶â€å†œä¸šå¤§æ•°æ®åˆ†æå¹³å°</h1>

        <!-- æŒ‰é’®å®¹å™¨ -->
        <div class="button-container">
            <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
            <button class="logout-button" onclick="logoutAndRefresh()">é€€å‡ºç™»å½•</button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai-message">
                ğŸŒ± æ¬¢è¿ä½¿ç”¨å†œåœºç®¡å®¶ï¼æ‚¨å¯ä»¥å’¨è¯¢ï¼š<br><br>
                1. åŒ—äº¬æœªæ¥ä¸‰å¤©å¤©æ°”å¯¹å°éº¦çš„å½±å“<br>
                2. é˜´é›¨å¤©å¦‚ä½•é¢„é˜²è‘¡è„ç—…å®³<br>
                3. å½“å‰æ¹¿åº¦é€‚åˆæ°´ç¨»æ’­ç§å—ï¼Ÿ
            </div>
        </div>

        <div class="input-container">
            <input type="text" id="questionInput" placeholder="è¯·è¾“å…¥å†œä¸šç›¸å…³é—®é¢˜...">
            <button id="sendButton">å‘é€</button>
        </div>
    </div>

    <script>
        // ================= ç™»å½•æ³¨å†Œé€»è¾‘ =================
        function showLogin() {
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('registerBox').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('registerBox').style.display = 'block';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.querySelector('.main-content').style.display = 'block';
        }

        // ================= ä¸»ç¨‹åºé€»è¾‘ =================
        const CONFIG = {
            GLM_API_KEY: "cf8a07f6e12a4fce92084bbe9affb10c.UvQ1v2oB4Q1jwZkD",
            JUHE_WEATHER_KEY: "33f5f5fc500f1d26650c5b67ea225259e",
            SUPPORT_CITIES: [
                'åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æˆéƒ½',
                'é‡åº†', 'æ­¦æ±‰', 'éƒ‘å·', 'è¥¿å®‰', 'æ­å·'
            ],
            CACHE_TTL: 600000
        };

        const weatherCache = {
            storage: new Map(),
            set(city, data) {
                this.storage.set(city, {
                    data,
                    timestamp: Date.now()
                });
            },
            get(city) {
                const record = this.storage.get(city);
                if (!record) return null;
                if (Date.now() - record.timestamp > CONFIG.CACHE_TTL) {
                    this.storage.delete(city);
                    return null;
                }
                return record.data;
            }
        };

        const utils = {
            isWeatherQuestion(text) {
                return /å¤©æ°”|æ°”å€™|æ°”æ¸©|é¢„æŠ¥|é™é›¨|æ¸©åº¦|æ¹¿åº¦|æ°”è±¡/.test(text);
            },
            sanitizeInput(text) {
                const escapeMap = {
                    '<': '&lt;',
                    '>': '&gt;',
                    '&': '&amp;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[<>&"']/g, m => escapeMap[m]);
            },
            extractCity(text) {
                return CONFIG.SUPPORT_CITIES.find(city =>
                    new RegExp(city).test(text)
                ) || null;
            }
        };

        const weatherServiceMain = {
            async fetch(city) {
                try {
                    const cached = weatherCache.get(city);
                    if (cached) return cached;

                    const response = await fetch(
                        `http://apis.juhe.cn/simpleWeather/query?city=${encodeURIComponent(city)}&key=${CONFIG.JUHE_WEATHER_KEY}`
                    );

                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.error_code !== 0) {
                        console.error('[å¤©æ°”æœåŠ¡] æ•°æ®é”™è¯¯:', data.error_msg);
                        return null;
                    }

                    const formatted = {
                        city: data.result.city,
                        realtime: {
                            temp: data.result.realtime.temperature,
                            humidity: data.result.realtime.humidity,
                            wind: `${data.result.realtime.direct} ${data.result.realtime.power}`,
                            aqi: data.result.realtime.aqi || 'æ— æ•°æ®'
                        },
                        forecast: data.result.future.slice(0, 3).map(d => ({
                            date: d.date,
                            weather: d.weather,
                            temp: d.temperature
                        }))
                    };

                    weatherCache.set(city, formatted);
                    return formatted;
                } catch (error) {
                    console.error('[å¤©æ°”æœåŠ¡] è¯·æ±‚å¤±è´¥:', error);
                    return null;
                }
            }
        };

        const aiService = {
            async generateAnswer(question, weather) {
                try {
                    const prompt = this.buildPrompt(question, weather);
                    const response = await fetch('https://open.bigmodel.cn/api/paas/v3/model-api/chatglm_turbo/invoke', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': CONFIG.GLM_API_KEY
                        },
                        body: JSON.stringify({
                            prompt,
                            temperature: 0.3
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.code !== 200) {
                        console.error('[AIæœåŠ¡] æ•°æ®é”™è¯¯:', data.message);
                        return null;
                    }

                    const answer = data.data.choices[0].content.replace(/\\n/g, '\n');
                    return answer;
                } catch (error) {
                    console.error('[AIæœåŠ¡] è¯·æ±‚å¤±è´¥:', error);
                    return null;
                }
            },
            buildPrompt(question, weather) {
                let weatherContext = '';
                if (weather) {
                    weatherContext = `
ã€å®æ—¶å¤©æ°”ç›‘æµ‹ã€‘ğŸŒ¤ï¸
ğŸ“ åŸå¸‚ï¼š${weather.city}
ğŸŒ¡ï¸ æ¸©åº¦ï¼š${weather.realtime.temp}â„ƒ
ğŸ’§ æ¹¿åº¦ï¼š${weather.realtime.humidity}%
ğŸŒ¬ï¸ é£åŠ›ï¼š${weather.realtime.wind}
ğŸŒ«ï¸ ç©ºæ°”è´¨é‡ï¼š${weather.realtime.aqi}

ã€ä¸‰æ—¥å¤©æ°”é¢„æŠ¥ã€‘ğŸ“…
${weather.forecast.map(d =>
                        `â†’ ${d.date} | ${d.weather} | ${d.temp}`
                    ).join('\n')}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
                }
                return `${weatherContext}ä½œä¸ºå†œä¸šä¸“å®¶ï¼Œè¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š
â“ é—®é¢˜ï¼š${question}

ğŸ“ å›ç­”è¦æ±‚ï¼š
1. ${weather ? 'ç»“åˆå¤©æ°”æ•°æ®åˆ†æ' : 'åˆ†ç‚¹è¯´æ˜'}
2. æä¾›å¯æ“ä½œçš„è§£å†³æ–¹æ¡ˆ
3. ä½¿ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€
4. å…³é”®æ•°æ®ç”¨ã€ã€‘æ ‡å‡º`;
            }
        };

        const uiController = (() => {
            const elements = {
                input: document.getElementById('questionInput'),
                container: document.getElementById('chatContainer'),
                button: document.getElementById('sendButton')
            };

            Object.entries(elements).forEach(([name, element]) => {
                if (!element) throw new Error(`æœªæ‰¾åˆ°å…ƒç´ : ${name}`);
            });

            return {
                elements,
                addMessage(content, isUser) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                    messageDiv.innerHTML = content.replace(/\n/g, '<br>');
                    this.elements.container.appendChild(messageDiv);
                    this.elements.container.scrollTop = this.elements.container.scrollHeight;
                },
                showLoading() {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'message ai-message loading-message';
                    loadingDiv.textContent = 'ğŸŒ¾ æ­£åœ¨åˆ†ææ•°æ®ï¼Œè¯·ç¨å€™...';
                    this.elements.container.appendChild(loadingDiv);
                },
                toggleButtonState(disabled) {
                    this.elements.button.disabled = disabled;
                },
                clearInput() {
                    this.elements.input.value = '';
                }
            };
        })();

        async function handleSend() {
            try {
                const rawInput = uiControllerã€‚elementsã€‚inputã€‚value.trim();
                if (!rawInput) return;

                const safeInput = utilsã€‚sanitizeInput(rawInput);
                uiController.addMessage(safeInputï¼Œ true);
                uiController.clearInput();
                uiController.toggleButtonState(true);
                uiController.showLoading();

                let weatherData = null;
                if (utilsã€‚isWeatherQuestion(safeInput)) {
                    const city = utils.extractCity(safeInput);
                    if (city) weatherData = await weatherServiceMain.fetch(city);
                }

                const response = await aiService.generateAnswer(safeInput, weatherData);
                if (response) {
                    uiController.addMessage(response, false);
                } else {
                    uiControllerã€‚addMessage('âš ï¸ æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•'ï¼Œ false);
                }
            } catch (error) {
                uiControllerã€‚addMessage('âš ï¸ ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•'ï¼Œ false);
            } finally {
                uiControllerã€‚toggleButtonState(false);
            }
        }

        function logoutAndRefresh() {
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
            localStorageã€‚removeItem('isLoggedIn');
            localStorage.removeItem('user');

            // åˆ·æ–°é¡µé¢
            locationã€‚reload();
        }

        function initEventListeners() {
            uiController.elements.button.addEventListener('click', handleSend);
            uiController.elements.input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('authModal').style.display = 'flex';
            initEventListeners();
        });
    </script>
</body>

</html>
